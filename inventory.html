<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المخزون - شيخ العرب</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root {
            /* Color Palette */
            --bg-light: #F0F4F8; /* Light blueish white background */
            --surface-white: #FFFFFF; /* Pure white for cards/elements */
            --text-dark: #2C3E50; /* Dark blueish black for primary text */
            --text-secondary: #607D8B; /* Medium blueish gray for secondary text */
            --accent-blue: #03A9F4; /* Light Blue for primary actions/highlights */
            --error-red: #FF5252; /* Red for errors/warnings */
            --success-green: #4CAF50; /* Green for success */
            --info-yellow: #FFC107; /* Yellow for specific info/warnings */

            --border-radius-soft: 12px;

            /* Light Shadows */
            --shadow-elevation-1: 0 4px 12px rgba(0, 0, 0, 0.08); /* Soft shadow for elements */
            --shadow-elevation-2: 0 8px 20px rgba(0, 0, 0, 0.12); /* Slightly stronger for hover/active */
            --shadow-input-focus: 0 0 0 3px rgba(3, 169, 244, 0.3); /* Blue ring for focus */

            /* Smaller overall scaling */
            --base-font-size: 0.95em;
            --padding-base: 12px;
            --margin-base: 15px;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            direction: rtl;
            text-align: right;
            display: flex;
            min-height: 100vh;
            font-size: var(--base-font-size); /* Applied smaller base font size */
        }

        /* Sidebar Styling */
        .sidebar {
            width: 260px; /* Slightly smaller sidebar */
            background-color: var(--surface-white);
            box-shadow: var(--shadow-elevation-1);
            padding: 25px 15px; /* Smaller padding */
            display: flex;
            flex-direction: column;
            align-items: center;
            border-radius: 0 var(--border-radius-soft) var(--border-radius-soft) 0;
            flex-shrink: 0;
        }

        .logo {
            font-family: 'Cairo', sans-serif;
            font-size: 2.2em; /* Slightly smaller logo */
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 40px; /* Smaller margin */
            text-align: center;
            line-height: 1.2;
            padding-bottom: 8px; /* Smaller padding */
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            width: 100%;
        }
        .logo span {
            color: var(--accent-blue);
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        .nav-item {
            margin-bottom: 8px; /* Smaller margin */
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 18px; /* Smaller padding */
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 1em; /* Relative to base-font-size */
            font-weight: 600;
            border-radius: var(--border-radius-soft);
            transition: all 0.3s ease;
        }

        .nav-link i {
            font-size: 1.3em; /* Slightly smaller icon */
            margin-left: 12px; /* Smaller margin */
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .nav-link:hover {
            background-color: var(--bg-light);
            color: var(--accent-blue);
        }

        .nav-link:hover i {
            color: var(--accent-blue);
        }

        .nav-link.active {
            background-color: var(--accent-blue);
            color: var(--surface-white);
            box-shadow: var(--shadow-elevation-1);
        }

        .nav-link.active i {
            color: var(--surface-white);
        }

        .nav-item.logout {
            margin-top: auto;
            width: 100%;
        }

        .nav-link.logout-btn {
            background-color: var(--error-red);
            color: var(--surface-white);
            justify-content: center;
            margin-top: 15px; /* Smaller margin */
        }

        .nav-link.logout-btn i {
            color: var(--surface-white);
        }

        .nav-link.logout-btn:hover {
            background-color: #D32F2F;
            color: var(--surface-white);
        }

        /* Main Content Styling */
        .main-content {
            flex-grow: 1;
            padding: 25px 30px; /* Smaller padding */
            overflow-y: auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px; /* Smaller margin */
        }

        .page-header h1 {
            font-size: 2.2em; /* Smaller heading */
            font-weight: 700;
            color: var(--text-dark);
        }

        .action-buttons {
            display: flex;
            align-items: center;
            gap: 12px; /* Smaller spacing between buttons */
        }

        .action-buttons button {
            padding: 10px 20px; /* Smaller padding */
            border: none;
            border-radius: var(--border-radius-soft);
            font-size: 0.95em; /* Smaller font */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-elevation-1);
            font-family: 'Cairo', sans-serif;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px; /* Smaller space between icon and text */
        }

        .action-buttons button i {
            font-size: 1.1em; /* Smaller icon */
        }

        .btn-primary {
            background-color: var(--accent-blue);
            color: var(--surface-white);
        }
        .btn-primary:hover {
            background-color: #0288D1;
            box-shadow: var(--shadow-elevation-2);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--surface-white);
            color: var(--text-dark);
            border: 1px solid #E0E6EB;
        }
        .btn-secondary:hover {
            background-color: var(--bg-light);
            box-shadow: var(--shadow-elevation-2);
            transform: translateY(-2px);
        }

        /* Admin Override Button */
        .btn-admin-override {
            background-color: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 6px; /* Smaller padding */
            border-radius: 50%;
            font-size: 1.4em; /* Smaller icon */
            box-shadow: none;
            order: -1;
        }
        .btn-admin-override:hover {
            color: var(--accent-blue);
            background-color: var(--bg-light);
            transform: scale(1.1);
            box-shadow: var(--shadow-elevation-1);
        }


        /* Search and Filter Section */
        .filter-section {
            background-color: var(--surface-white);
            padding: 20px; /* Smaller padding */
            border-radius: var(--border-radius-soft);
            box-shadow: var(--shadow-elevation-1);
            margin-bottom: 25px; /* Smaller margin */
            display: flex;
            gap: 15px; /* Smaller gap */
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-section .input-group {
            flex: 1;
            min-width: 200px; /* Smaller min-width */
            margin-bottom: 0;
            position: relative;
        }

        .filter-section .input-group input,
        .filter-section .input-group select {
            width: 100%;
            padding: 10px 15px; /* Smaller padding */
            background-color: var(--bg-light);
            border: 1px solid #E0E6EB;
            border-radius: var(--border-radius-soft);
            color: var(--text-dark);
            font-size: 0.95em; /* Smaller font */
            box-sizing: border-box;
            outline: none;
            transition: all 0.3s ease;
            -webkit-appearance: none; /* Remove default select arrow */
            -moz-appearance: none;
            appearance: none;
            /* Custom arrow for select fields */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22%23607D8B%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M5.293%207.293a1%201%200%20011.414%200L10%2010.586l3.293-3.293a1%201%200%20111.414%201.414l-4%204a1%201%200%2001-1.414%200l-4-4a1%201%200%20010-1.414z%22%20clip-rule%3D%22evenodd%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: left 0.8rem center; /* Adjust for RTL */
            background-size: 1.2em; /* Smaller arrow */
        }
        /* Remove default clear button for search input in WebKit browsers */
        input[type="search"]::-webkit-search-cancel-button {
            -webkit-appearance: none;
        }

        .filter-section .input-group input:focus,
        .filter-section .input-group select:focus {
            border-color: var(--accent-blue);
            box-shadow: var(--shadow-input-focus);
        }

        .filter-section .input-group label {
            display: none;
        }
        
        /* Product Table */
        .product-table-container {
            background-color: var(--surface-white);
            padding: 15px; /* Smaller padding */
            border-radius: var(--border-radius-soft);
            box-shadow: var(--shadow-elevation-1);
            overflow-x: auto;
        }

        .product-table {
            width: 100%;
            border-collapse: collapse;
            text-align: right;
        }

        .product-table th, .product-table td {
            padding: 12px 10px; /* Smaller padding */
            border-bottom: 1px solid #E0E6EB;
            font-size: 0.9em; /* Smaller font */
            color: var(--text-dark);
        }

        .product-table th {
            background-color: var(--bg-light);
            font-weight: 700;
            color: var(--text-dark);
            white-space: nowrap;
        }

        .product-table tbody tr:hover {
            background-color: var(--bg-light);
        }

        .product-table .actions button {
            background: none;
            border: none;
            color: var(--accent-blue);
            font-size: 1.1em; /* Smaller icon */
            cursor: pointer;
            margin-right: 8px; /* Smaller margin */
            transition: color 0.3s ease;
        }
        .product-table .actions button:hover {
            color: #0288D1;
        }
        .product-table .actions button.delete-btn {
            color: var(--error-red);
        }
        .product-table .actions button.delete-btn:hover {
            color: #D32F2F;
        }

        /* Modal for Add/Edit Product */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--surface-white);
            margin: auto;
            padding: 25px; /* Smaller padding */
            border-radius: var(--border-radius-soft);
            box-shadow: var(--shadow-elevation-2);
            width: 95%; /* Wider on all screens */
            max-width: 900px; /* Max width on large screens */
            height: 95vh; /* Taller on all screens */
            max-height: 95vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px; /* Smaller margin */
            border-bottom: 1px solid rgba(0, 0, 0, 0.05); /* Lighter border */
            padding-bottom: 12px; /* Smaller padding */
            flex-shrink: 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.6em; /* Smaller heading */
            color: var(--text-dark);
            font-weight: 700;
        }

        .modal-close {
            color: var(--text-secondary);
            font-size: 1.8em; /* Smaller close icon */
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .modal-close:hover {
            color: var(--error-red);
        }

        .modal-body {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 15px; /* Smaller padding */
            display: grid; /* Use grid for layout */
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Responsive columns */
            gap: 20px; /* Spacing between grid items */
        }
        /* Full width for barcode input with icon */
        .modal-body .input-group:last-of-type { /* Targeting the barcode input group */
            grid-column: 1 / -1; /* Make it span all columns */
            display: flex;
            align-items: flex-end; /* Align input and button to bottom */
            gap: 10px; /* Space between input and icon button */
            position: relative; /* For error message positioning */
        }
        .modal-body .input-group:last-of-type input {
            flex-grow: 1; /* Allow input to take available space */
        }
        .modal-body .input-group:last-of-type .btn-secondary {
            flex-shrink: 0; /* Prevent button from shrinking */
            width: auto; /* Allow button to size naturally */
            padding: 8px 12px; /* Smaller padding for icon button */
            font-size: 1.2em; /* Just the icon size */
            margin-top: 0; /* Override default margin */
            border-radius: var(--border-radius-soft);
        }
        .modal-body .input-group:last-of-type .btn-secondary span {
            display: none; /* Hide text, only show icon */
        }
        .modal-body .input-group:last-of-type .error-message {
            position: absolute;
            bottom: -20px; /* Position below the input group */
            left: 0; /* Align left (right in RTL) */
            width: 100%;
            text-align: right;
        }


        .modal-body .input-group label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 5px; /* Smaller margin */
            font-size: 0.95em;
            display: block;
        }

        .modal-body .input-group input,
        .modal-body .input-group select {
            width: 100%;
            padding: 10px 15px; /* Smaller padding */
            border: 1px solid #E0E6EB;
            border-radius: var(--border-radius-soft);
            font-size: 0.95em; /* Smaller font */
            color: var(--text-dark);
            background-color: var(--bg-light);
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22%23607D8B%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M5.293%207.293a1%201%200%20011.414%200L10%2010.586l3.293-3.293a1%201%200%20111.414%201.414l-4%204a1%201%200%2001-1.414%200l-4-4a1%201%200%20010-1.414z%22%20clip-rule%3D%22evenodd%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: left 0.8rem center; /* Adjust for RTL */
            background-size: 1.2em;
        }
        .modal-body .input-group input:focus,
        .modal-body .input-group select:focus {
            border-color: var(--accent-blue);
            box-shadow: var(--shadow-input-focus);
        }

        .modal-footer {
            margin-top: 20px; /* Smaller margin */
            text-align: left;
            flex-shrink: 0;
        }
        .modal-footer button {
            padding: 10px 20px; /* Smaller padding */
            border: none;
            border-radius: var(--border-radius-soft);
            font-size: 0.95em; /* Smaller font */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-elevation-1);
            font-family: 'Cairo', sans-serif;
            margin-left: 12px; /* Smaller spacing */
        }

        .modal-footer .btn-save {
            background-color: var(--accent-blue);
            color: var(--surface-white);
        }
        .modal-footer .btn-save:hover {
            background-color: #0288D1;
            box-shadow: var(--shadow-elevation-2);
        }

        .modal-footer .btn-cancel {
            background-color: var(--text-secondary);
            color: var(--surface-white);
        }
        .modal-footer .btn-cancel:hover {
            background-color: #4A6572;
        }

        .error-message {
            color: var(--error-red);
            font-size: 0.8em; /* Smaller font */
            margin-top: 4px; /* Smaller margin */
            text-align: right; /* Changed from center to right for consistency */
            display: block;
            font-weight: 400;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .error-message.show {
            visibility: visible;
            opacity: 1;
        }

        /* Scan Feedback UI */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 25px; /* Smaller spinner */
            height: 25px;
            border-radius: 50%;
            border-left-color: var(--accent-blue);
            animation: spin 1s ease infinite;
            display: none;
            margin: 0 auto;
        }
        /* Removed .scan-prompt styling as it's now handled by notifications */

        /* Admin Action Buttons in table actions */
        .product-table .actions .admin-action-btn {
            background-color: var(--info-yellow);
            color: var(--text-dark);
            font-size: 0.8em;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: none; /* Hidden by default */
        }
        .product-table .actions .admin-action-btn:hover {
            background-color: #fdd835;
        }
        .product-table .actions .admin-action-btn.active {
            background-color: var(--success-green);
            color: var(--surface-white);
        }
        .product-table .actions .admin-action-btn.active:hover {
            background-color: #388E3C;
        }
        /* Hide default edit/delete buttons in admin mode */
        .product-table .actions .edit-btn.hidden-by-admin,
        .product-table .actions .delete-btn.hidden-by-admin {
            display: none !important;
        }


        /* Notification System */
        #notification-container {
            position: fixed;
            bottom: 20px;
            left: 20px; /* Moved to bottom-left (in RTL, this is bottom-right) */
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-start; /* Align notifications to the left */
        }

        .notification {
            background-color: var(--surface-white);
            color: var(--text-dark);
            padding: 12px 18px; /* Smaller padding */
            border-radius: var(--border-radius-soft);
            box-shadow: var(--shadow-elevation-1);
            min-width: 200px; /* Smaller min-width */
            max-width: 300px; /* Smaller max-width */
            opacity: 0;
            transform: translateX(-100%); /* Start off-screen to the left */
            animation: slideIn 0.5s forwards, fadeOut 0.5s forwards 4.5s;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px; /* Smaller gap */
            font-weight: 600;
            font-size: 0.9em; /* Smaller font for notification */
        }

        .notification.success {
            border-left: 5px solid var(--success-green); /* Green border on left */
        }
        .notification.error {
            border-left: 5px solid var(--error-red); /* Red border on left */
        }
        .notification.info {
            border-left: 5px solid var(--accent-blue); /* Blue border on left */
        }
        .notification.warning {
            border-left: 5px solid var(--info-yellow); /* Yellow border on left */
        }

        .notification i {
            font-size: 1.3em; /* Smaller icon */
            color: var(--text-secondary);
        }

        @keyframes slideIn {
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(-100%); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar {
                width: 100%; height: auto; padding: 20px;
                border-radius: var(--border-radius-soft) var(--border-radius-soft) 0 0;
                flex-direction: row; justify-content: space-around; flex-wrap: wrap;
                font-size: 1em; /* Reset font size for mobile sidebar */
            }
            .logo { display: none; }
            .nav-list { display: flex; flex-wrap: wrap; justify-content: center; width: 100%; }
            .nav-item { margin: 5px; }
            .nav-link { padding: 10px 15px; font-size: 0.9em; flex-direction: column; text-align: center; }
            .nav-link i { margin: 0 0 5px 0; }
            .nav-item.logout { margin-top: 10px; width: auto; }
            .main-content { padding: 20px; }
            .page-header { flex-direction: column; align-items: flex-end; }
            .page-header h1 { margin-bottom: 20px; font-size: 2em; }
            .action-buttons { width: 100%; display: flex; justify-content: space-around; flex-wrap: wrap; }
            .action-buttons button { margin: 5px; }
            .filter-section { flex-direction: column; align-items: stretch; }
            .filter-section .input-group { min-width: auto; width: 100%; }
            .modal-content {
                width: 98%; /* Even wider on small screens */
                height: 98vh; /* Even taller on small screens */
                padding: 15px; /* Smaller padding */
            }
            .modal-footer { text-align: center; }
            .modal-footer button { margin: 5px; }
            #notification-container {
                bottom: 10px;
                left: 10px;
                right: 10px; /* Allow notifications to spread on small screens */
                align-items: center; /* Center them horizontally */
            }
            .notification {
                min-width: unset;
                max-width: 90%;
            }
            .modal-body {
                grid-template-columns: 1fr; /* Single column on small screens */
                gap: 15px;
            }
            .modal-body .input-group:last-of-type {
                flex-direction: column; /* Stack barcode input and button */
                align-items: stretch;
            }
            .modal-body .input-group:last-of-type .btn-secondary {
                width: 100%; /* Full width for the button */
                padding: 10px 15px;
                font-size: 1em; /* Restore default button font size */
            }
             .modal-body .input-group:last-of-type .btn-secondary span {
                display: inline; /* Show text again for barcode button on small screens */
            }
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo">
            شيخ <span>العرب</span>
        </div>
        <ul class="nav-list">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link">
                    <i class="ri-dashboard-line"></i>
                    <span>الصفحة الرئيسية</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="inventory.html" class="nav-link active"> <i class="ri-box-3-line"></i>
                    <span>إدارة المخزون</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="pos.html" class="nav-link">
                    <i class="ri-shopping-cart-line"></i>
                    <span>نقطة البيع</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="settings.html" class="nav-link">
                    <i class="ri-settings-3-line"></i>
                    <span>الإعدادات</span>
                </a>
            </li>
            <li class="nav-item logout">
                <a href="#" id="logoutButton" class="nav-link logout-btn">
                    <i class="ri-logout-box-line"></i>
                    <span>تسجيل الخروج</span>
                </a>
            </li>
        </ul>
    </aside>

    <main class="main-content">
        <div class="page-header">
            <h1>إدارة المخزون</h1>
            <div class="action-buttons">
                <button class="btn-admin-override" id="adminOverrideBtn" title="صلاحيات المسؤول"><i class="ri-shield-user-line"></i></button>
                <button class="btn-primary" id="addProductBtn">
                    <i class="ri-add-line"></i>
                    <span>إضافة منتج جديد</span>
                </button>
                <button class="btn-secondary" id="requestScanForSearchBtn">
                    <i class="ri-qr-code-line"></i>
                    <span>طلب مسح QR للبحث</span>
                </button>
            </div>
        </div>

        <div class="filter-section">
            <div class="input-group">
                <input type="search" id="searchProduct" placeholder="البحث بالاسم أو الكود..." autocomplete="off">
            </div>
            <div class="input-group">
                <select id="filterCategory">
                    <option value="">كل الفئات</option>
                    <option value="بهارات">بهارات</option>
                    <option value="حبوب">حبوب</option>
                    <option value="أعشاب">أعشاب</option>
                    <option value="زيوت">زيوت</option>
                    <option value="مكسرات">مكسرات</option>
                    <option value="عسل">عسل</option>
                    <option value="تمور">تمور</option>
                    <option value="بقوليات">بقوليات</option>
                    <option value="مجففات">مجففات</option>
                    <option value="عطور وبخور">عطور وبخور</option>
                    <option value="أخرى">أخرى</option>
                </select>
            </div>
            </div>

        <div class="spinner" id="scanSpinner" style="display: none;"></div>
        <p class="scan-prompt" id="scanPrompt" style="display: none;"></p>
        <button class="btn-secondary" id="cancelScanRequestBtn" style="display: none; margin-top: 15px;"><i class="ri-close-line"></i> إلغاء طلب المسح</button>


        <div class="product-table-container">
            <table class="product-table">
                <thead>
                    <tr>
                        <th>الكود</th>
                        <th>اسم المنتج</th>
                        <th>الفئة</th>
                        <th>الكمية المتاحة</th>
                        <th>سعر الوحدة (جنيه)</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                    </tbody>
            </table>
        </div>

        </main>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">إضافة منتج جديد</h2>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="productName">اسم المنتج</label>
                    <input type="text" id="productName" required>
                    <span class="error-message" id="productNameError"></span>
                </div>
                <div class="input-group">
                    <label for="productCategory">الفئة</label>
                    <select id="productCategory">
                        <option value="">اختر فئة</option>
                        <option value="بهارات">بهارات</option>
                        <option value="حبوب">حبوب</option>
                        <option value="أعشاب">أعشاب</option>
                        <option value="زيوت">زيوت</option>
                        <option value="مكسرات">مكسرات</option>
                        <option value="عسل">عسل</option>
                        <option value="تمور">تمور</option>
                        <option value="بقوليات">بقوليات</option>
                        <option value="مجففات">مجففات</option>
                        <option value="عطور وبخور">عطور وبخور</option>
                        <option value="أخرى">أخرى</option>
                    </select>
                    <span class="error-message" id="productCategoryError"></span>
                </div>
                <div class="input-group">
                    <label for="productQuantity">الكمية المتاحة</label>
                    <input type="number" id="productQuantity" min="0" step="0.01" required>
                    <span class="error-message" id="productQuantityError"></span>
                </div>
                <div class="input-group">
                    <label for="productUnit">وحدة القياس</label>
                    <select id="productUnit">
                        <option value="جرام">جرام (g)</option>
                        <option value="كيلو جرام">كيلو جرام (kg)</option>
                        <option value="قطعة">قطعة</option>
                        <option value="لتر">لتر (L)</option>
                        <option value="مليلتر">مليلتر (ml)</option>
                        <option value="عبوة">عبوة</option>
                        <option value="كوب">كوب</option>
                        <option value="كيس">كيس</option>
                        <option value="علبة">علبة</option>
                        <option value="حبة">حبة</option>
                    </select>
                    <span class="error-message" id="productUnitError"></span>
                </div>
                <div class="input-group">
                    <label for="productPricePerUnit">سعر الوحدة (جنيه)</label>
                    <input type="number" id="productPricePerUnit" min="0" step="0.01" required>
                    <span class="error-message" id="productPricePerUnitError"></span>
                </div>
                <div class="input-group">
                    <label for="productBarcode">كود المنتج / QR (اختياري)</label>
                    <input type="text" id="productBarcode" placeholder="امسح أو أدخل الكود" autocomplete="off">
                    <button type="button" class="btn-secondary" id="requestScanForNewProduct">
                        <i class="ri-qr-code-line"></i>
                        <span>مسح QR</span> </button>
                    <span class="error-message" id="productBarcodeError"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-save" id="saveProductBtn">حفظ المنتج</button>
                <button type="button" class="btn-cancel" id="cancelProductBtn">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="adminPasswordModal" class="modal">
        <div class="modal-content" style="max-width: 400px; height: auto;">
            <div class="modal-header">
                <h2 id="adminModalTitle">صلاحيات المسؤول</h2>
                <span class="modal-close" id="adminModalClose">&times;</span>
            </div>
            <div class="modal-body" style="display: block;"> <div class="input-group">
                    <label for="adminPassword">كلمة المرور</label>
                    <input type="password" id="adminPassword" placeholder="أدخل كلمة مرور المسؤول" autocomplete="off">
                    <span class="error-message" id="adminPasswordError"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-save" id="verifyAdminPasswordBtn">تأكيد</button>
                <button type="button" class="btn-cancel" id="cancelAdminPasswordBtn">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="notification-container"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, getDoc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";

        // ************* Firebase Configuration (MUST MATCH QR SCANNER PAGE) *************
        const firebaseConfig = {
            apiKey: "AIzaSyC5ls-rPdJ65x5BoMGwAOpdcPtD585C2ys", // <--- هذا يجب أن يتطابق مع qr_scanner.html
            authDomain: "pharmacy-inventory-bf04a.firebaseapp.com", // <--- هذا يجب أن يتطابق مع qr_scanner.html
            projectId: "pharmacy-inventory-bf04a", // <--- هذا يجب أن يتطابق مع qr_scanner.html
            storageBucket: "pharmacy-inventory-bf04a.firebasestorage.app",
            messagingSenderId: "937788650384",
            appId: "1:937788650384:web:6451225d00e648f3a0b915",
            measurementId: "G-ZGC9EQ55SL"
        };
        // *********************************************************************************

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const productsCol = collection(db, "products");
        const scannerSessionsCol = collection(db, "scannerSessions"); // New collection for scanner communication
        const analytics = getAnalytics(app);

        // ************* SHARED SCANNER SESSION ID (MUST MATCH QR SCANNER PAGE) *************
        const SHARED_SCANNER_SESSION_ID = "YOUR_STORE_UNIQUE_SCANNER_ID_12345"; // <--- هذا يجب أن يتطابق مع qr_scanner.html
        const scannerSessionDocRef = doc(db, 'scannerSessions', SHARED_SCANNER_SESSION_ID);
        // ************************************************************************************

        // UI elements for scan feedback
        const scanSpinner = document.getElementById('scanSpinner'); // Kept for now, but not used as heavily
        const scanPrompt = document.getElementById('scanPrompt'); // Kept for now, but not used as heavily
        const cancelScanRequestBtn = document.getElementById('cancelScanRequestBtn'); // Kept for consistency

        let scannerSessionUnsubscribe = null; // To store the unsubscribe function for the Firestore listener

        // Admin Override Elements
        const adminOverrideBtn = document.getElementById('adminOverrideBtn');
        const adminPasswordModal = document.getElementById('adminPasswordModal');
        const adminModalClose = document.getElementById('adminModalClose');
        const adminPasswordInput = document.getElementById('adminPassword');
        const adminPasswordError = document.getElementById('adminPasswordError');
        const verifyAdminPasswordBtn = document.getElementById('verifyAdminPasswordBtn');
        const cancelAdminPasswordBtn = document.getElementById('cancelAdminPasswordBtn');

        // Admin default password (for client-side verification - NOT SECURE FOR PRODUCTION)
        let ADMIN_PASSWORD = "010274"; // This should ideally be fetched from Firestore and compared server-side/securely

        let isAdminModeActive = localStorage.getItem('isAdminModeActive') === 'true'; // Load from localStorage
        let isEditActive = isAdminModeActive;
        let isDeleteActive = isAdminModeActive;
        let isAddActive = isAdminModeActive;

        // Notification System
        const notificationContainer = document.getElementById('notification-container');
        let lastNotificationMessage = ''; // To prevent duplicate consecutive notifications
        let notificationTimeoutId = null; // To manage notification timeout

        function showNotification(message, type = 'info') {
            // Check if the exact same message was shown recently to prevent spam
            if (message === lastNotificationMessage) {
                return;
            }

            // Clear any previous notification visuals instantly if a new one arrives
            if (notificationContainer.firstChild) {
                notificationContainer.innerHTML = ''; // Clears previous notifications
            }
            
            // Clear existing timeout if a new notification arrives quickly
            if (notificationTimeoutId) {
                clearTimeout(notificationTimeoutId);
            }

            const notificationDiv = document.createElement('div');
            notificationDiv.classList.add('notification', type);
            let iconClass = '';
            if (type === 'success') iconClass = 'ri-check-line';
            else if (type === 'error') iconClass = 'ri-error-warning-line';
            else if (type === 'warning') iconClass = 'ri-alert-line';
            else iconClass = 'ri-information-line';

            notificationDiv.innerHTML = `<i class="${iconClass}"></i><span>${message}</span>`;
            
            notificationContainer.appendChild(notificationDiv);

            // Trigger reflow to restart animation (important for consecutive notifications)
            void notificationDiv.offsetWidth;
            notificationDiv.style.opacity = '1';
            notificationDiv.style.transform = 'translateX(0)';

            lastNotificationMessage = message; // Store last message

            // Set timeout for fading out
            notificationTimeoutId = setTimeout(() => {
                notificationDiv.style.opacity = '0';
                notificationDiv.style.transform = 'translateX(-100%)'; // Slide out to the left
                notificationTimeoutId = null; // Reset timeout ID
                // Remove from DOM after animation completes
                notificationDiv.addEventListener('transitionend', () => {
                    if (notificationDiv.parentNode) {
                        notificationDiv.parentNode.removeChild(notificationDiv);
                    }
                }, { once: true });
                lastNotificationMessage = ''; // Clear last message after it fades out
            }, 5000); // Notification stays for 5 seconds
        }


        // Authentication Check
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
            }
        });

        // Logout Functionality
        document.getElementById('logoutButton').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await signOut(auth);
                showNotification("تم تسجيل الخروج بنجاح.", "info");
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Error signing out:", error);
                showNotification("حدث خطأ أثناء تسجيل الخروج. يرجى المحاولة مرة أخرى.", "error");
            }
        });

        // Inventory Management Logic
        const addProductBtn = document.getElementById('addProductBtn');
        const productModal = document.getElementById('productModal');
        const modalClose = document.querySelector('.modal-close');
        const saveProductBtn = document.getElementById('saveProductBtn');
        const cancelProductBtn = document.getElementById('cancelProductBtn');
        const productForm = document.getElementById('productForm');
        const modalTitle = document.getElementById('modalTitle');
        const productsTableBody = document.getElementById('productsTableBody');
        const searchProductInput = document.getElementById('searchProduct');
        const filterCategorySelect = document.getElementById('filterCategory');
        const requestScanForSearchBtn = document.getElementById('requestScanForSearchBtn');
        const requestScanForNewProductBtn = document.getElementById('requestScanForNewProduct'); // New button for modal

        let editingProductId = null;

        const productNameInput = document.getElementById('productName');
        const productCategorySelect = document.getElementById('productCategory');
        const productQuantityInput = document.getElementById('productQuantity');
        const productUnitSelect = document.getElementById('productUnit');
        const productPricePerUnitInput = document.getElementById('productPricePerUnit');
        const productBarcodeInput = document.getElementById('productBarcode');

        const productNameError = document.getElementById('productNameError');
        const productCategoryError = document.getElementById('productCategoryError');
        const productQuantityError = document.getElementById('productQuantityError');
        const productUnitError = document.getElementById('productUnitError');
        const productPricePerUnitError = document.getElementById('productPricePerUnitError');
        const productBarcodeError = document.getElementById('productBarcodeError');

        function showError(element, message) {
            element.textContent = message;
            element.classList.add('show');
        }

        function clearError(element) {
            element.textContent = '';
            element.classList.remove('show');
        }

        function clearAllErrors() {
            clearError(productNameError);
            clearError(productCategoryError);
            clearError(productQuantityError);
            clearError(productUnitError);
            clearError(productPricePerUnitError);
            clearError(productBarcodeError);
            clearError(adminPasswordError); // Clear admin password error too
        }

        // Open Modal (for Add/Edit Product)
        addProductBtn.addEventListener('click', () => {
            if (!isAdminModeActive || !isAddActive) {
                showNotification("لا تملك صلاحية إضافة المنتجات.", "warning");
                return;
            }
            modalTitle.textContent = 'إضافة منتج جديد';
            productForm.reset();
            clearAllErrors();
            editingProductId = null;
            productModal.style.display = 'flex';
        });

        // Close Modal
        modalClose.addEventListener('click', () => {
            productModal.style.display = 'none';
        });
        cancelProductBtn.addEventListener('click', () => {
            productModal.style.display = 'none';
        });
        window.addEventListener('click', (event) => {
            if (event.target == productModal) {
                productModal.style.display = 'none';
            }
        });

        // Save Product (Add/Edit)
        saveProductBtn.addEventListener('click', async () => {
            clearAllErrors();

            const name = productNameInput.value.trim();
            const category = productCategorySelect.value;
            const quantity = parseFloat(productQuantityInput.value);
            const unit = productUnitSelect.value;
            const pricePerUnit = parseFloat(productPricePerUnitInput.value);
            const barcode = productBarcodeInput.value.trim();

            let isValid = true;

            if (!name) { showError(productNameError, 'الرجاء إدخال اسم المنتج.'); isValid = false; }
            if (!category) { showError(productCategoryError, 'الرجاء اختيار فئة.'); isValid = false; }
            if (isNaN(quantity) || quantity < 0) { showError(productQuantityError, 'الرجاء إدخال كمية صحيحة.'); isValid = false; }
            if (!unit) { showError(productUnitError, 'الرجاء اختيار وحدة القياس.'); isValid = false; }
            if (isNaN(pricePerUnit) || pricePerUnit < 0) { showError(productPricePerUnitError, 'الرجاء إدخال سعر صحيح لكل وحدة.'); isValid = false; }

            if (!isValid) {
                showNotification("الرجاء إكمال البيانات المطلوبة بشكل صحيح.", "warning");
                return;
            }

            // Determine product status based on quantity and unit
            let status = 'متوفر';
            if (unit === 'جرام' && quantity <= 100 && quantity > 0) {
                status = 'قليل المخزون';
            } else if (quantity === 0) {
                status = 'نفد المخزون';
            } else if (unit !== 'جرام' && quantity <= 5 && quantity > 0) {
                 status = 'قليل المخزون';
            }

            const productData = {
                name,
                category,
                quantity,
                unit,
                pricePerUnit,
                barcode: barcode || null,
                status: status,
                createdAt: editingProductId ? undefined : new Date(),
                updatedAt: new Date()
            };

            try {
                if (editingProductId) {
                    if (!isAdminModeActive || !isEditActive) {
                        showNotification("لا تملك صلاحية تعديل المنتجات.", "error");
                        return;
                    }
                    const productRef = doc(db, "products", editingProductId);
                    await updateDoc(productRef, productData);
                    showNotification('تم تحديث المنتج بنجاح!', "success");
                } else {
                    if (!isAdminModeActive || !isAddActive) {
                        showNotification("لا تملك صلاحية إضافة المنتجات.", "error");
                        return;
                    }
                    await addDoc(productsCol, productData);
                    showNotification('تم إضافة المنتج بنجاح!', "success");
                }
                productModal.style.display = 'none';
                fetchProducts();
            } catch (e) {
                console.error("Error adding/updating document: ", e);
                showNotification('حدث خطأ أثناء حفظ المنتج. يرجى المحاولة مرة أخرى.', "error");
            }
        });

        // Fetch and Display Products
        async function fetchProducts() {
            productsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">جاري تحميل المنتجات...</td></tr>';
            
            const searchQuery = searchProductInput.value.toLowerCase().trim();
            const categoryFilter = filterCategorySelect.value;
            
            let products = [];

            try {
                const querySnapshot = await getDocs(productsCol);
                querySnapshot.forEach((doc) => {
                    products.push({ id: doc.id, ...doc.data() });
                });

                if (categoryFilter) {
                    products = products.filter(product => product.category === categoryFilter);
                }

                if (searchQuery) {
                    products = products.filter(product =>
                        (product.name && product.name.toLowerCase().includes(searchQuery)) ||
                        (product.barcode && product.barcode.toLowerCase().includes(searchQuery))
                    );
                }

                displayProducts(products);
                updateAdminActionButtonsVisibility(); // Update button visibility after products are displayed
            } catch (e) {
                console.error("Error fetching products: ", e);
                productsTableBody.innerHTML = '<tr><td colspan="7" style="color: var(--error-red); text-align: center;">حدث خطأ أثناء تحميل المنتجات.</td></tr>';
                showNotification("خطأ في تحميل المنتجات.", "error");
            }
        }

        function displayProducts(products) {
            productsTableBody.innerHTML = '';
            if (products.length === 0) {
                productsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">لا توجد منتجات لعرضها.</td></tr>';
                return;
            }

            products.forEach(product => {
                const row = productsTableBody.insertRow();
                let statusColor = '';
                if (product.status === 'متوفر') statusColor = 'var(--success-green)';
                else if (product.status === 'قليل المخزون') statusColor = 'var(--info-yellow)';
                else if (product.status === 'نفد المخزون') statusColor = 'var(--error-red)';

                row.innerHTML = `
                    <td>${product.barcode || 'N/A'}</td>
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>${product.quantity} ${product.unit}</td>
                    <td>${parseFloat(product.pricePerUnit).toFixed(2)} جنيه</td>
                    <td style="color: ${statusColor}; font-weight: 600;">${product.status}</td>
                    <td class="actions">
                        <button title="تعديل" class="edit-btn ${isAdminModeActive ? 'hidden-by-admin' : ''}" data-id="${product.id}"><i class="ri-edit-line"></i></button>
                        <button title="حذف" class="delete-btn ${isAdminModeActive ? 'hidden-by-admin' : ''}" data-id="${product.id}"><i class="ri-delete-bin-line"></i></button>
                        <button class="admin-action-btn toggle-edit ${isEditActive ? 'active' : ''}" data-id="${product.id}" style="${isAdminModeActive ? 'display: inline-block;' : 'display: none;'}">تعديل</button>
                        <button class="admin-action-btn toggle-delete ${isDeleteActive ? 'active' : ''}" data-id="${product.id}" style="${isAdminModeActive ? 'display: inline-block;' : 'display: none;'}">حذف</button>
                    </td>
                `;
            });

            // Add event listeners for edit/delete buttons (default)
            productsTableBody.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.currentTarget.dataset.id;
                    if (!isAdminModeActive || !isEditActive) { // Only allow if admin mode and edit permission is active
                        showNotification("لا تملك صلاحية تعديل المنتجات.", "warning");
                        return;
                    }
                    editProduct(productId);
                });
            });
            productsTableBody.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.currentTarget.dataset.id;
                    if (!isAdminModeActive || !isDeleteActive) { // Only allow if admin mode and delete permission is active
                        showNotification("لا تملك صلاحية حذف المنتجات.", "warning");
                        return;
                    }
                    deleteProduct(productId);
                });
            });

            // Admin Toggle Buttons (for enabling/disabling edit/delete visually)
            productsTableBody.querySelectorAll('.admin-action-btn.toggle-edit').forEach(button => {
                button.addEventListener('click', (e) => {
                    isEditActive = !isEditActive;
                    localStorage.setItem('isEditActive', isEditActive); // Save state
                    updateAdminActionButtonsVisibility();
                    showNotification(isEditActive ? "صلاحية التعديل مفعلة." : "صلاحية التعديل معطلة.", 'info');
                });
            });
             productsTableBody.querySelectorAll('.admin-action-btn.toggle-delete').forEach(button => {
                button.addEventListener('click', (e) => {
                    isDeleteActive = !isDeleteActive;
                    localStorage.setItem('isDeleteActive', isDeleteActive); // Save state
                    updateAdminActionButtonsVisibility();
                    showNotification(isDeleteActive ? "صلاحية الحذف مفعلة." : "صلاحية الحذف معطلة.", 'info');
                });
            });
        }

        async function editProduct(productId) {
            try {
                const docRef = doc(db, "products", productId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const product = docSnap.data();
                    modalTitle.textContent = 'تعديل المنتج';
                    productNameInput.value = product.name;
                    productCategorySelect.value = product.category;
                    productQuantityInput.value = product.quantity;
                    productUnitSelect.value = product.unit;
                    productPricePerUnitInput.value = product.pricePerUnit;
                    productBarcodeInput.value = product.barcode || '';
                    editingProductId = productId;
                    clearAllErrors();
                    productModal.style.display = 'flex';
                } else {
                    showNotification("المنتج غير موجود.", "error");
                }
            } catch (e) {
                console.error("Error fetching product for edit: ", e);
                showNotification("حدث خطأ أثناء جلب بيانات المنتج للتعديل.", "error");
            }
        }

        async function deleteProduct(productId) {
            if (confirm('هل أنت متأكد أنك تريد حذف هذا المنتج؟')) {
                try {
                    await deleteDoc(doc(db, "products", productId));
                    showNotification('تم حذف المنتج بنجاح!', "success");
                    fetchProducts();
                } catch (e) {
                    console.error("Error removing document: ", e);
                    showNotification('حدث خطأ أثناء حذف المنتج. يرجى المحاولة مرة أخرى.', "error");
                }
            }
        }

        // Live Search and Filter Event Listeners
        searchProductInput.addEventListener('input', fetchProducts); // Live search on input
        filterCategorySelect.addEventListener('change', fetchProducts); // Live filter on category change


        // Initial fetch on page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchProducts();

            // Dynamic Active Tab Logic
            const navLinks = document.querySelectorAll('.nav-link');
            const currentPath = window.location.pathname.split('/').pop();

            navLinks.forEach(link => {
                const linkPath = link.getAttribute('href');
                if (linkPath === currentPath) {
                    link.classList.add('active');
                }
            });

            // Start listening to the scanner session on page load
            listenToScannerSession();

            // Initialize admin mode state on load
            isAddActive = isAdminModeActive;
            isEditActive = isAdminModeActive;
            isDeleteActive = isAdminModeActive;
            updateAdminActionButtonsVisibility(); // Set initial visibility

            // Placeholder for reports
            // updateReports(); // Will be called from dashboard or dedicated reports page

        });

        // --- QR Scanner Integration (using Firestore for communication) ---

        // Function to update the UI for scan request feedback
        // Removed `scanSpinner` and `scanPrompt` usage from here, now rely on notifications
        function updateScanFeedbackUI(showSpinner, showPrompt, promptMessage = '', showCancelBtn = false) {
            // These elements are now generally hidden or used minimally
            scanSpinner.style.display = showSpinner ? 'block' : 'none';
            scanPrompt.textContent = promptMessage;
            scanPrompt.style.display = showPrompt ? 'block' : 'none';
            cancelScanRequestBtn.style.display = showCancelBtn ? 'inline-flex' : 'none';
        }

        // Request a scan from the phone
        async function requestScan(purpose) {
            showNotification(`جاري طلب المسح لوضع ${purpose === 'search' ? 'البحث عن منتج' : 'إضافة باركود منتج جديد'} من الهاتف...`, "info");
            updateScanFeedbackUI(true, true, '', true); // Show spinner/cancel button as an overall UI state

            try {
                // Ensure the session document exists and is in a ready state
                const docSnap = await getDoc(scannerSessionDocRef);
                if (!docSnap.exists() || docSnap.data().status !== 'phoneReady') {
                    if (!docSnap.exists()) {
                         // Attempt to create the document if it doesn't exist
                        await setDoc(scannerSessionDocRef, {
                            status: 'desktopConnecting',
                            requestedBy: 'desktop',
                            createdAt: new Date(),
                            purpose: purpose,
                            scannedValue: null,
                            lastRequestTime: new Date()
                        });
                        showNotification("جاري إعداد الاتصال بماسح الهاتف. يرجى التأكد من فتح صفحة الماسح على الهاتف.", "info");
                    } else {
                        showNotification("ماسح الهاتف غير جاهز للمسح. يرجى التأكد من فتح صفحة الماسح على الهاتف.", "warning");
                        console.warn("Phone is not in 'phoneReady' state:", docSnap.data().status);
                    }
                     // After initial check/setup, update the status to trigger scan on phone
                    await updateDoc(scannerSessionDocRef, {
                        status: 'scanRequested',
                        purpose: purpose,
                        scannedValue: null, // Clear any previous scanned value
                        lastRequestTime: new Date()
                    });
                } else {
                    // If phone is ready, directly request scan
                    await updateDoc(scannerSessionDocRef, {
                        status: 'scanRequested',
                        purpose: purpose,
                        scannedValue: null, // Clear any previous scanned value
                        lastRequestTime: new Date()
                    });
                }

                console.log(`Scan request sent for purpose: ${purpose}`);

            } catch (error) {
                console.error("Error requesting scan:", error);
                showNotification("فشل طلب المسح. تأكد من اتصال Firebase.", "error");
                updateScanFeedbackUI(false, false); // Hide scan UI elements
                // Also update Firestore to signal error from desktop side if connection is there
                await updateDoc(scannerSessionDocRef, {
                    status: 'errorFromDesktop',
                    errorMessage: error.message,
                    errorTime: new Date()
                }).catch(e => console.error("Error signaling errorFromDesktop status:", e));
            }
        }

        // Listen to the scanner session document for updates from the phone
        function listenToScannerSession() {
            if (scannerSessionUnsubscribe) {
                scannerSessionUnsubscribe(); // Unsubscribe from previous listener if any
            }

            scannerSessionUnsubscribe = onSnapshot(scannerSessionDocRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("Scanner session data:", data);

                    if (data.status === 'phoneReady') {
                        showNotification("ماسح QR بالهاتف متصل وجاهز.", "success");
                        updateScanFeedbackUI(false, false); // Hide scan UI elements
                    } else if (data.status === 'scanning') {
                        showNotification(`الهاتف يقوم بالمسح لوضع ${data.purpose === 'search' ? 'البحث' : 'إضافة المنتج'}...`, "info");
                        updateScanFeedbackUI(true, false); // Show spinner, hide prompt
                    } else if (data.status === 'scanned' && data.scannedValue) {
                        // Phone has scanned a value
                        showNotification(`تم استلام الباركود: ${data.scannedValue}. جاري المعالجة...`, "info");
                        updateScanFeedbackUI(false, false); // Hide scan UI elements
                        
                        // Process the scanned value based on the purpose
                        if (data.purpose === 'search') {
                            searchProductInput.value = data.scannedValue;
                            fetchProducts(); // Trigger live search
                        } else if (data.purpose === 'add_new') {
                            productBarcodeInput.value = data.scannedValue;
                            productModal.style.display = 'flex'; // Keep modal open
                        }
                        
                        // Signal back to the phone that the desktop has processed the scan
                        await updateDoc(scannerSessionDocRef, {
                            status: 'readyForNextScan',
                            scannedValue: null, // Clear scanned value after processing
                            processedAt: new Date()
                        }).catch(e => console.error("Error updating session status to readyForNextScan:", e));

                        showNotification("تمت المعالجة. الهاتف جاهز لطلب مسح جديد.", "success");

                    } else if (data.status === 'closedByPhone') {
                        showNotification("تم قطع الاتصال بماسح QR بالهاتف.", "info");
                        updateScanFeedbackUI(false, false); // Hide scan UI elements
                        scannerSessionUnsubscribe(); // Stop listening
                        scannerSessionUnsubscribe = null;
                    } else if (data.status === 'errorFromPhone') {
                        showNotification(`خطأ في ماسح QR بالهاتف: ${data.errorMessage || 'غير معروف'}`, "error");
                        updateScanFeedbackUI(false, false); // Hide scan UI elements
                    } else if (data.status === 'errorFromDesktop') {
                        showNotification("فشل الاتصال بماسح QR. يرجى التحقق من الإعدادات.", "error");
                        updateScanFeedbackUI(false, false); // Hide scan UI elements
                    }

                } else {
                    // Document does not exist (e.g., deleted by phone or never created)
                    showNotification("ماسح QR بالهاتف غير نشط أو انتهت الجلسة. يرجى فتحه.", "warning");
                    updateScanFeedbackUI(false, false); // Hide scan UI elements
                    scannerSessionUnsubscribe(); // Stop listening
                    scannerSessionUnsubscribe = null;
                }
            }, (error) => {
                console.error("Error listening to scanner session on desktop:", error);
                showNotification("خطأ في الاتصال بماسح QR. يرجى إعادة تحميل الصفحة.", "error");
                updateScanFeedbackUI(false, false); // Hide scan UI elements
                scannerSessionUnsubscribe();
                scannerSessionUnsubscribe = null;
            });
        }

        // Event listeners for QR buttons
        requestScanForSearchBtn.addEventListener('click', () => requestScan('search'));
        requestScanForNewProductBtn.addEventListener('click', () => {
            // Check if adding is allowed
            if (!isAdminModeActive || !isAddActive) {
                showNotification("لا تملك صلاحية إضافة المنتجات.", "warning");
                return;
            }
            // productModal.style.display = 'flex'; // Keep modal open. No need to hide and show.
            requestScan('add_new');
        });

        cancelScanRequestBtn.addEventListener('click', async () => {
            // Cancel pending request by setting status back to phoneReady
            try {
                await updateDoc(scannerSessionDocRef, {
                    status: 'phoneReady',
                    scannedValue: null,
                    lastRequestTime: new Date()
                });
                showNotification("تم إلغاء طلب المسح.", "info");
                updateScanFeedbackUI(false, false); // Hide scan UI elements
            } catch (e) {
                console.error("Error cancelling scan request:", e);
                showNotification("فشل إلغاء طلب المسح.", "error");
                updateScanFeedbackUI(false, false); // Hide scan UI elements
            }
        });


        // --- Admin Override Logic ---
        adminOverrideBtn.addEventListener('click', () => {
            adminPasswordModal.style.display = 'flex';
            adminPasswordInput.value = '';
            clearError(adminPasswordError);
        });

        adminModalClose.addEventListener('click', () => {
            adminPasswordModal.style.display = 'none';
        });

        cancelAdminPasswordBtn.addEventListener('click', () => {
            adminPasswordModal.style.display = 'none';
        });

        verifyAdminPasswordBtn.addEventListener('click', () => {
            const enteredPassword = adminPasswordInput.value;
            if (enteredPassword === ADMIN_PASSWORD) {
                isAdminModeActive = !isAdminModeActive; // Toggle admin mode
                localStorage.setItem('isAdminModeActive', isAdminModeActive); // Save state to localStorage

                isAddActive = isAdminModeActive;
                isEditActive = isAdminModeActive;
                isDeleteActive = isAdminModeActive;
                localStorage.setItem('isAddActive', isAddActive);
                localStorage.setItem('isEditActive', isEditActive);
                localStorage.setItem('isDeleteActive', isDeleteActive);


                adminPasswordModal.style.display = 'none';
                showNotification(isAdminModeActive ? "تم تفعيل وضع المسؤول بنجاح." : "تم إلغاء تفعيل وضع المسؤول.", "success");
                updateAdminActionButtonsVisibility(); // Update button visibility
                fetchProducts(); // Re-render table to reflect changes
            } else {
                showError(adminPasswordError, "كلمة المرور غير صحيحة.");
                showNotification("كلمة المرور غير صحيحة.", "error");
            }
        });

        function updateAdminActionButtonsVisibility() {
            const adminActionButtons = productsTableBody.querySelectorAll('.admin-action-btn');
            const defaultEditButtons = productsTableBody.querySelectorAll('.edit-btn');
            const defaultDeleteButtons = productsTableBody.querySelectorAll('.delete-btn');

            if (isAdminModeActive) {
                // Show admin toggle buttons, hide default edit/delete
                adminActionButtons.forEach(btn => btn.style.display = 'inline-block');
                defaultEditButtons.forEach(btn => btn.classList.add('hidden-by-admin'));
                defaultDeleteButtons.forEach(btn => btn.classList.add('hidden-by-admin'));

                // Update "Add New Product" button state
                if (isAddActive) {
                    addProductBtn.classList.add('btn-primary');
                    addProductBtn.classList.remove('btn-secondary');
                    addProductBtn.style.opacity = '1';
                    addProductBtn.style.cursor = 'pointer';
                } else {
                     addProductBtn.classList.add('btn-secondary');
                     addProductBtn.classList.remove('btn-primary');
                     addProductBtn.style.opacity = '0.7';
                     addProductBtn.style.cursor = 'not-allowed';
                }

                 // Visual feedback for admin permissions within the table (toggle buttons)
                adminActionButtons.forEach(btn => {
                    if (btn.classList.contains('toggle-edit')) {
                        if (isEditActive) btn.classList.add('active'); else btn.classList.remove('active');
                    } else if (btn.classList.contains('toggle-delete')) {
                        if (isDeleteActive) btn.classList.add('active'); else btn.classList.remove('active');
                    }
                });

            } else {
                // Hide admin toggle buttons and show default edit/delete
                adminActionButtons.forEach(btn => btn.style.display = 'none');
                defaultEditButtons.forEach(btn => btn.classList.remove('hidden-by-admin'));
                defaultDeleteButtons.forEach(btn => btn.classList.remove('hidden-by-admin'));
                
                // Ensure Add New Product button is always active (default state for non-admin)
                addProductBtn.classList.add('btn-primary');
                addProductBtn.classList.remove('btn-secondary');
                addProductBtn.style.opacity = '1';
                addProductBtn.style.cursor = 'pointer';
            }
        }

        // Event listener for admin toggle buttons (these will be added to newly created rows)
        productsTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('toggle-edit')) {
                // This toggles the _permission state for the entire section_, not just one row
                // For per-row permission, you'd need more complex state management
                isEditActive = !isEditActive;
                localStorage.setItem('isEditActive', isEditActive);
                showNotification(isEditActive ? "صلاحية التعديل مفعلة." : "صلاحية التعديل معطلة.", "info");
                updateAdminActionButtonsVisibility(); // Re-render to update visual state
            } else if (e.target.classList.contains('toggle-delete')) {
                isDeleteActive = !isDeleteActive;
                localStorage.setItem('isDeleteActive', isDeleteActive);
                showNotification(isDeleteActive ? "صلاحية الحذف مفعلة." : "صلاحية الحذف معطلة.", "info");
                updateAdminActionButtonsVisibility();
            }
        });
        
        // --- Placeholder for Reports Logic (will need actual data from sales etc.) ---
        // Function to update reports (now global for potential use in other pages)
        // This function would fetch sales data, calculate profits, etc.
        /*
        async function updateReports() {
            // Placeholder values. In a real app, this would query sales and expense data.
            document.getElementById('dailySales').textContent = `1500.00 جنيه`; // Assuming element exists in relevant page
            document.getElementById('topSellingProduct').textContent = `كمون حصى`; // Assuming element exists in relevant page
            document.getElementById('estimatedProfit').textContent = `450.00 جنيه`; // Assuming element exists in relevant page
        }
        */

        // Future: Admin password can be fetched from Firestore and updated in settings.html
        // For example, in settings.html:
        /*
        async function updateAdminPassword(newPassword) {
            const adminSettingsRef = doc(db, 'settings', 'admin'); // A document for admin settings
            await updateDoc(adminSettingsRef, { adminPassword: newPassword });
            ADMIN_PASSWORD = newPassword; // Update local variable
            showNotification("تم تغيير كلمة مرور المسؤول بنجاح.", "success");
        }
        // Then, on app load, fetch ADMIN_PASSWORD from Firestore
        // This requires Firebase Security Rules to allow only authenticated admins to read/write this.
        */

    </script>
</body>
</html>
