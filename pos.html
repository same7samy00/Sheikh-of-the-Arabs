<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نقطة البيع - شيخ العرب</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
</head>
<body>
    <aside class="sidebar">
        <div class="logo">شيخ <span>العرب</span></div>
        <ul class="nav-list">
            <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="ri-dashboard-line"></i><span>الرئيسية</span></a></li>
            <li class="nav-item"><a href="inventory.html" class="nav-link"><i class="ri-inbox-line"></i><span>المخزون</span></a></li>
            <li class="nav-item"><a href="pos.html" class="nav-link active"><i class="ri-store-2-line"></i><span>نقطة البيع</span></a></li>
            <li class="nav-item logout"><a href="#" id="logoutButton" class="nav-link"><i class="ri-logout-box-r-line"></i><span>خروج</span></a></li>
        </ul>
    </aside>

    <div class="page-container">
        <header class="main-header">
            <h3>نقطة البيع الاحترافية</h3>
        </header>
        <main class="main-content">
            <div class="pos-layout">
                <section class="pos-main">
                    <input type="search" id="productSearchInput" placeholder="البحث بالاسم أو امسح الكود...">
                    <div id="category-filters">
                        </div>
                    <div id="product-grid">
                        <div class="placeholder-text">جاري تحميل المنتجات...</div>
                    </div>
                </section>
                <aside class="pos-sidebar">
                    <div class="cart">
                        <h2 class="cart-header">الفاتورة</h2>
                        <div id="cart-items-list">
                            <div class="placeholder-text">السلة فارغة</div>
                        </div>
                        <div class="cart-summary">
                            <div class="summary-row"><span>المجموع الفرعي</span><span id="subtotal">0.00</span></div>
                            <div class="summary-row" id="discount-row" style="display: none;"><span>الخصم</span><span id="discount">0.00</span></div>
                            <div class="summary-row"><span>الضريبة (14%)</span><span id="tax">0.00</span></div>
                            <div class="summary-row total"><span>الإجمالي (جنيه)</span><span id="total">0.00</span></div>
                        </div>
                        <div id="pos-actions">
                            <button class="btn btn-secondary" id="clearSaleBtn">إلغاء</button>
                            <button class="btn" id="discount-btn">خصم</button>
                            <button class="btn btn-primary" id="checkoutBtn" disabled>الدفع</button>
                        </div>
                    </div>
                </aside>
            </div>
        </main>
    </div>

    <div id="weight-modal" class="modal-overlay"> </div>
    <div id="payment-modal" class="modal-overlay"> </div>
    <div id="discount-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>تطبيق خصم</h2>
            <div class="input-group">
                <label for="discountValue">قيمة الخصم (مبلغ ثابت أو %)</label>
                <input type="text" id="discountValue" placeholder="مثال: 10 أو 5%">
            </div>
            <button class="btn btn-primary" id="applyDiscountBtn" style="width:100%;">تطبيق</button>
        </div>
    </div>
    
    <div id="notification-container"></div>
    <script src="shared.js" type="module"></script>
    <script type="module">
        import { collection, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { db, showNotification } from './shared.js';

        let allProducts = [], cart = [], categories = new Set();
        let discount = { type: 'fixed', value: 0 };
        const TAX_RATE = 0.14;
        const WEIGHT_UNITS = ['جرام', 'كيلو جرام'];

        const productGrid = document.getElementById('product-grid');
        const categoryFilters = document.getElementById('category-filters');
        const searchInput = document.getElementById('productSearchInput');
        const cartList = document.getElementById('cart-items-list');
        const subtotalEl = document.getElementById('subtotal'), taxEl = document.getElementById('tax'), totalEl = document.getElementById('total');
        const discountRow = document.getElementById('discount-row'), discountEl = document.getElementById('discount');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const discountBtn = document.getElementById('discount-btn');
        const discountModal = document.getElementById('discount-modal');

        const initializePOS = async () => {
            try {
                const snapshot = await getDocs(collection(db, "products"));
                allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allProducts.forEach(p => categories.add(p.category));
                renderCategories();
                renderProductGrid(allProducts);
            } catch (error) {
                showNotification("فشل تحميل المنتجات", "error");
            }
        };

        const renderCategories = () => {
            categoryFilters.innerHTML = '<button class="category-btn active" data-category="all">الكل</button>';
            categories.forEach(cat => {
                categoryFilters.innerHTML += `<button class="category-btn" data-category="${cat}">${cat}</button>`;
            });
        };

        const renderProductGrid = (products) => {
            productGrid.innerHTML = '';
            products.forEach(p => {
                if (p.quantity > 0) {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.dataset.id = p.id;
                    card.innerHTML = `<div class="product-card-name">${p.name}</div><div class="product-card-price">${p.pricePerUnit.toFixed(2)} / ${p.unit}</div>`;
                    productGrid.appendChild(card);
                }
            });
        };

        const renderCart = () => {
            cartList.innerHTML = '';
            if (cart.length === 0) {
                cartList.innerHTML = '<div class="placeholder-text">السلة فارغة</div>';
            } else {
                cart.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'cart-item';
                    const subtotal = (item.pricePerUnit * item.quantity).toFixed(2);
                    const isWeight = WEIGHT_UNITS.includes(item.unit);
                    itemDiv.innerHTML = `
                        <div class="cart-item-details">
                            <div class="name">${item.name}</div>
                            <div class="info">${item.quantity} ${isWeight ? 'جرام' : 'قطعة'}</div>
                        </div>
                        <div class="cart-item-subtotal">${subtotal}</div>
                        <div class="cart-item-actions">
                            ${!isWeight ? `<div class="cart-qty-controls"><button class="qty-btn" data-id="${item.id}" data-change="-1">-</button><span>${item.quantity}</span><button class="qty-btn" data-id="${item.id}" data-change="1">+</button></div>` : ''}
                            <button class="remove-item-btn" data-id="${item.id}"><i class="ri-delete-bin-line"></i></button>
                        </div>
                    `;
                    cartList.appendChild(itemDiv);
                });
            }
            updateSummary();
        };

        const updateSummary = () => {
            const subtotal = cart.reduce((acc, item) => acc + (item.pricePerUnit * item.quantity), 0);
            let discountValue = 0;
            if (discount.type === 'percentage') {
                discountValue = subtotal * (discount.value / 100);
            } else {
                discountValue = discount.value;
            }

            if (discountValue > 0) {
                discountRow.style.display = 'flex';
                discountEl.textContent = `-${discountValue.toFixed(2)}`;
            } else {
                discountRow.style.display = 'none';
            }

            const totalAfterDiscount = subtotal - discountValue;
            const tax = totalAfterDiscount * TAX_RATE;
            const total = totalAfterDiscount + tax;
            
            subtotalEl.textContent = subtotal.toFixed(2);
            taxEl.textContent = tax.toFixed(2);
            totalEl.textContent = total.toFixed(2);
            checkoutBtn.disabled = cart.length === 0;
        };
        
        // Event Listeners
        categoryFilters.addEventListener('click', e => {
            if (e.target.matches('.category-btn')) {
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                const category = e.target.dataset.category;
                const productsToShow = category === 'all' ? allProducts : allProducts.filter(p => p.category === category);
                renderProductGrid(productsToShow);
            }
        });

        productGrid.addEventListener('click', e => {
            const card = e.target.closest('.product-card');
            if (card) {
                const product = allProducts.find(p => p.id === card.dataset.id);
                // For simplicity, this example adds one unit. The weight modal logic can be re-integrated here.
                const existing = cart.find(item => item.id === product.id);
                if (existing) {
                    existing.quantity++;
                } else {
                    cart.push({ ...product, quantity: 1 });
                }
                renderCart();
            }
        });
        
        discountBtn.addEventListener('click', () => discountModal.classList.add('show'));
        document.getElementById('applyDiscountBtn').addEventListener('click', () => {
            const input = document.getElementById('discountValue').value;
            if (input.includes('%')) {
                discount.type = 'percentage';
                discount.value = parseFloat(input.replace('%', '')) || 0;
            } else {
                discount.type = 'fixed';
                discount.value = parseFloat(input) || 0;
            }
            updateSummary();
            discountModal.classList.remove('show');
        });

        // Initialize
        initializePOS();
    </script>
</body>
</html>
