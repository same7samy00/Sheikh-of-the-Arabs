<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نقطة البيع - شيخ العرب</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
</head>
<body>
    <aside class="sidebar">
        <div class="logo">شيخ <span>العرب</span></div>
        <ul class="nav-list">
            <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="ri-dashboard-line"></i><span>الرئيسية</span></a></li>
            <li class="nav-item"><a href="inventory.html" class="nav-link"><i class="ri-box-3-line"></i><span>المخزون</span></a></li>
            <li class="nav-item"><a href="pos.html" class="nav-link active"><i class="ri-shopping-cart-2-line"></i><span>نقطة البيع</span></a></li>
            <li class="nav-item logout"><a href="#" id="logoutButton" class="nav-link logout-btn"><i class="ri-logout-box-r-line"></i><span>خروج</span></a></li>
        </ul>
    </aside>

    <main class="main-content">
        <div class="pos-layout">
            <section class="pos-main">
                <div id="product-search-bar">
                    <input type="search" id="productSearchInput" placeholder="البحث بالاسم أو امسح الكود...">
                    <button class="btn btn-secondary" id="requestScanBtn" title="مسح باركود"><i class="ri-qr-code-line"></i></button>
                </div>
                <div id="product-grid">
                    <div class="placeholder-text">جاري تحميل المنتجات...</div>
                </div>
            </section>

            <aside class="pos-sidebar">
                <div class="cart">
                    <h2 class="cart-header">سلة المشتريات</h2>
                    <div id="cart-items-list">
                        <div class="placeholder-text">السلة فارغة</div>
                    </div>
                    <div class="cart-summary">
                        <div class="summary-row"><span>المجموع الفرعي</span><span id="subtotal">0.00</span></div>
                        <div class="summary-row"><span>الضريبة (14%)</span><span id="tax">0.00</span></div>
                        <div class="summary-row total"><span>الإجمالي (جنيه)</span><span id="total">0.00</span></div>
                    </div>
                    <div id="pos-actions">
                        <button class="btn btn-secondary" id="clearSaleBtn">إلغاء</button>
                        <button class="btn btn-primary" id="checkoutBtn" disabled>الدفع</button>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <div id="weight-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h2>إدخال الوزن</h2><button class="modal-close-btn">&times;</button></div>
            <p>الرجاء إدخال الوزن بالجرام لـ <strong class="product-prompt-name"></strong></p>
            <div class="input-group"><label for="weightInput">الوزن (جرام)</label><input type="number" id="weightInput" min="1"></div>
            <button class="btn btn-primary" id="confirmWeightBtn" style="width:100%;">إضافة للسلة</button>
        </div>
    </div>

    <div id="payment-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h2>إتمام الدفع</h2><button class="modal-close-btn">&times;</button></div>
            <div class="input-group"><label>المبلغ الإجمالي</label><input type="text" id="totalAmountToPay" disabled></div>
            <div class="input-group"><label for="amountTendered">المبلغ المدفوع</label><input type="number" id="amountTendered"></div>
            <div class="input-group"><label>الباقي</label><input type="text" id="changeDue" disabled></div>
            <button class="btn btn-primary" id="confirmPaymentBtn" style="width:100%;">تأكيد الدفع</button>
        </div>
    </div>

    <div id="receipt-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h2>الفاتورة</h2><button class="modal-close-btn">&times;</button></div>
            <div id="receipt-container"></div>
            <button class="btn btn-secondary" id="printReceiptBtn" style="width:100%; margin-top: 20px;"><i class="ri-printer-line"></i> طباعة</button>
        </div>
    </div>

    <div id="notification-container"></div>
    <script src="shared.js" type="module"></script>
    <script type="module">
        import { collection, getDocs, doc, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { db, showNotification, requestScan, listenToScannerSession, showConfirmation } from './shared.js';

        let allProducts = [], cart = [];
        const TAX_RATE = 0.14;
        const WEIGHT_UNITS = ['جرام', 'كيلو جرام'];

        const productGrid = document.getElementById('product-grid');
        const searchInput = document.getElementById('productSearchInput');
        const cartList = document.getElementById('cart-items-list');
        const subtotalEl = document.getElementById('subtotal'), taxEl = document.getElementById('tax'), totalEl = document.getElementById('total');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const modals = { weight: document.getElementById('weight-modal'), payment: document.getElementById('payment-modal'), receipt: document.getElementById('receipt-modal') };

        const getProductById = (id) => allProducts.find(p => p.id === id);

        const renderProductGrid = (products) => {
            productGrid.innerHTML = '';
            const inStock = products.filter(p => p.quantity > 0);
            if (inStock.length === 0) {
                productGrid.innerHTML = '<div class="placeholder-text">لا توجد منتجات تطابق البحث.</div>';
                return;
            }
            inStock.forEach(p => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.dataset.id = p.id;
                card.innerHTML = `<div class="product-card-name">${p.name}</div><div class="product-card-price">${p.pricePerUnit.toFixed(2)} / ${p.unit}</div>`;
                productGrid.appendChild(card);
            });
        };

        const calculateItemSubtotal = (item) => (item.unit === 'كيلو جرام') ? (item.pricePerUnit / 1000) * item.quantity : item.pricePerUnit * item.quantity;

        const renderCart = () => {
            cartList.innerHTML = '';
            if (cart.length === 0) {
                cartList.innerHTML = '<div class="placeholder-text">السلة فارغة</div>';
                checkoutBtn.disabled = true;
                updateSummary();
                return;
            }
            cart.forEach(item => {
                const isWeight = WEIGHT_UNITS.includes(item.unit);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                itemDiv.innerHTML = `
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-info">${item.quantity} ${isWeight ? 'جرام' : 'قطعة'} &times; ${item.pricePerUnit.toFixed(2)}/${item.unit}</div>
                    </div>
                    <div class="cart-item-price">${calculateItemSubtotal(item).toFixed(2)}</div>
                    <button class="cart-item-remove" data-id="${item.id}"><i class="ri-delete-bin-line"></i></button>
                `;
                cartList.appendChild(itemDiv);
            });
            updateSummary();
            checkoutBtn.disabled = false;
        };

        const updateSummary = () => {
            const subtotal = cart.reduce((acc, item) => acc + calculateItemSubtotal(item), 0);
            const tax = subtotal * TAX_RATE;
            subtotalEl.textContent = subtotal.toFixed(2);
            taxEl.textContent = tax.toFixed(2);
            totalEl.textContent = (subtotal + tax).toFixed(2);
        };

        const addItemToCart = (product, quantity) => {
            const existingItem = cart.find(item => item.id === product.id);
            const isWeight = WEIGHT_UNITS.includes(product.unit);
            if (existingItem && !isWeight) {
                existingItem.quantity += quantity;
            } else {
                if(existingItem) cart = cart.filter(i => i.id !== product.id);
                cart.push({ ...product, quantity });
            }
            showNotification(`تمت إضافة "${product.name}"`, 'success');
            renderCart();
        };

        const handleProductSelection = (id) => {
            const product = getProductById(id);
            if (!product || product.quantity <= 0) return showNotification("المنتج غير متوفر", "error");
            if (WEIGHT_UNITS.includes(product.unit)) {
                modals.weight.querySelector('.product-prompt-name').textContent = product.name;
                modals.weight.dataset.productId = id;
                modals.weight.classList.add('show');
                document.getElementById('weightInput').focus();
            } else {
                addItemToCart(product, 1);
            }
        };

        const finalizeSale = async () => {
            const batch = writeBatch(db);
            for (const item of cart) {
                const product = getProductById(item.id);
                if (item.quantity > product.quantity) return showNotification(`الكمية المطلوبة من "${item.name}" غير متوفرة`, "error");
                const productRef = doc(db, "products", item.id);
                batch.update(productRef, { quantity: product.quantity - item.quantity });
            }
            try {
                await batch.commit();
                showNotification("تمت عملية البيع بنجاح!", "success");
                generateReceipt();
                modals.payment.classList.remove('show');
                modals.receipt.classList.add('show');
                await initializePOS(); // Refresh stock data
            } catch (error) {
                showNotification("فشل تحديث المخزون.", "error");
            }
        };

        const generateReceipt = () => {
            const now = new Date();
            const total = parseFloat(totalEl.textContent);
            const tendered = parseFloat(document.getElementById('amountTendered').value) || total;
            let itemsHtml = '';
            cart.forEach(item => {
                const subtotal = calculateItemSubtotal(item);
                itemsHtml += `<tr><td>${item.name} (${item.quantity}${WEIGHT_UNITS.includes(item.unit) ? 'g' : ''})</td><td>${subtotal.toFixed(2)}</td></tr>`;
            });
            document.getElementById('receipt-container').innerHTML = `
                <h3>شيخ العرب للعطارة</h3>
                <p>${now.toLocaleString('ar-EG')}</p>
                <hr>
                <table>
                    <thead><tr><th>المنتج</th><th>السعر</th></tr></thead>
                    <tbody>${itemsHtml}</tbody>
                </table>
                <hr>
                <table>
                    <tr class="summary-row"><td>المجموع الفرعي:</td><td>${subtotalEl.textContent}</td></tr>
                    <tr class="summary-row"><td>الضريبة:</td><td>${taxEl.textContent}</td></tr>
                    <tr class="summary-row total-row"><td>الإجمالي:</td><td>${total.toFixed(2)}</td></tr>
                    <tr class="summary-row"><td>المدفوع:</td><td>${tendered.toFixed(2)}</td></tr>
                    <tr class="summary-row"><td>الباقي:</td><td>${(tendered - total).toFixed(2)}</td></tr>
                </table>
                <p>شكراً لزيارتكم!</p>
            `;
        };

        // Event Listeners
        productGrid.addEventListener('click', e => e.target.closest('.product-card') && handleProductSelection(e.target.closest('.product-card').dataset.id));
        cartList.addEventListener('click', e => e.target.closest('.cart-item-remove') && (cart = cart.filter(i => i.id !== e.target.closest('.cart-item-remove').dataset.id), renderCart()));
        searchInput.addEventListener('input', () => renderProductGrid(allProducts.filter(p => p.name.toLowerCase().includes(searchInput.value.toLowerCase()))));
        document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', () => btn.closest('.modal-overlay').classList.remove('show')));
        document.getElementById('confirmWeightBtn').addEventListener('click', () => {
            const id = modals.weight.dataset.productId;
            const weight = parseFloat(document.getElementById('weightInput').value);
            if (!id || !weight || weight <= 0) return showNotification("الرجاء إدخال وزن صحيح", "error");
            addItemToCart(getProductById(id), weight);
            modals.weight.classList.remove('show');
        });
        checkoutBtn.addEventListener('click', () => {
            document.getElementById('totalAmountToPay').value = totalEl.textContent + ' جنيه';
            document.getElementById('amountTendered').value = '';
            document.getElementById('changeDue').value = '';
            modals.payment.classList.add('show');
        });
        document.getElementById('amountTendered').addEventListener('input', e => {
            const total = parseFloat(totalEl.textContent);
            const tendered = parseFloat(e.target.value) || 0;
            document.getElementById('changeDue').value = (tendered - total) >= 0 ? (tendered - total).toFixed(2) + ' جنيه' : '';
        });
        document.getElementById('confirmPaymentBtn').addEventListener('click', finalizeSale);
        document.getElementById('printReceiptBtn').addEventListener('click', () => window.print());
        modals.receipt.querySelector('.modal-close-btn').addEventListener('click', () => {
            cart = [];
            renderCart();
        });
        document.getElementById('clearSaleBtn').addEventListener('click', () => cart.length > 0 && showConfirmation("هل أنت متأكد من إلغاء هذه الفاتورة؟", () => (cart = [], renderCart())));
        document.getElementById('requestScanBtn').addEventListener('click', () => requestScan('pos_add'));
        listenToScannerSession((scannedValue, purpose) => {
            if (purpose === 'pos_add' && scannedValue) {
                const product = allProducts.find(p => p.barcode === scannedValue);
                if (product) handleProductSelection(product.id); else showNotification("منتج غير موجود", "error");
            }
        });
        
        // Initial Load
        initializePOS();

    </script>
</body>
</html>
